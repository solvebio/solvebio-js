<html>
    <title>SolveBio.js Example</title>
    <head>
        <script src="../dist/solvebio.js"></script>
        <script src="../dist/solvebio-promises.js"></script>
        <!-- <script src='https://raw.githubusercontent.com/solvebio/solvebio-js/master/dist/solvebio.js'></script> -->
        <!-- <script src='https://raw.githubusercontent.com/solvebio/solvebio-js/master/dist/solvebio-promises.js'></script> -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    </head>
    <body>
        <h3>Beacon Datasets for Gene + AA Variant</h3>
        <p>Beacon public or private datasets for a mutation, given gene + AA (or other) variant.</p>
        <form id="form-beacons">
            <label for="query">Variant</label>
            <input type="text" name="query" value="BRAF V600E">
            <select name="visibility">
                <option value="public">Public Datasets</option>
                <option value="private">Private Datasets</option>
            </select>
            <button type="submit">Beacon</button>
            <pre id="form-beacons-output"></pre>
        </form>

        <script>
            SolveBio.init({
                apiHost: 'https://api-stag.solvebio.com',
                accessToken: 'dcaplan_sod9ckgjl8nyx764jlszll'
                // accessToken: 'ACCESS TOKEN'
            });

            // Beacon datasets given form input
            $("#form-beacons").submit(function(event) {
                var query = $("#form-beacons input[name=query]").val();
                var visibility = $("#form-beacons select[name=visibility] option:selected").val();
                var output = $("#form-beacons-output");
                $("#form-beacons-output").text("");

                SolveBio.Expression('entity_ids("variant", query)', 'string', true)
                    .evaluate({query: query})
                    .then(function(response) {
                        // NOTE: There may be multiple entity IDs returned for a variant.
                        if (!response.result[0]) {
                            output.text("Variant could not be normalized");
                            return;
                        }

                        output.append("Normalized variant IDs: \n" + response.result.join("\n") + "\n\n");
                        output.append("Beacon results: \n");

                        response.result.map(function(variant) {
                            SolveBio.Expression('beacon(variant, "variant", visibility=visibility)', 'object', false)
                                .evaluate({variant: variant, visibility: visibility})
                                .then(function(response) {
                                    var datasets = response.result.found;
                                    if (datasets.length === 0) {
                                        output.append("No beacons matched: " + variant + "\n");
                                    }
                                    else {
                                        datasets.map(function(d) {
                                            output.append(variant + " -> " + d + "\n");
                                        });
                                    }
                                });
                        });
                    });

                event.preventDefault();
            });

        </script>
    </body>
</html>
