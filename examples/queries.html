<html>
    <title>SolveBio.js Example</title>
    <head>
        <script src="../dist/solvebio.js"></script>
        <script src="../dist/solvebio-promises.js"></script>
        <!-- <script src='https://raw.githubusercontent.com/solvebio/solvebio-js/master/dist/solvebio.js'></script> -->
        <!-- <script src='https://raw.githubusercontent.com/solvebio/solvebio-js/master/dist/solvebio-promises.js'></script> -->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    </head>
    <body>
        <h3>Query a dataset for Gene + AA Variant</h3>
        <p>Query public datasets for a mutation, given gene + AA (or other) variant.</p>
        <form id="form-query">
            <label for="query">Variant</label>
            <input type="text" name="query" value="BRAF V600E">
            <select name="dataset">
                <option value="ClinVar/3.7.4-2017-01-30/Variants">ClinVar</option>
                <option value="ICGC/3.0.0-23/SimpleSomaticMutation">ICGC</option>
                <option value="CIViC/2.0.1-2016-12-28/Variants">CIViC</option>
                <option value="dbSNP/1.0.1-b147/Variants">dbSNP</option>
                <option value="CancerHotspots/1.0.0-2016-08-08/Variants">CancerHotspots</option>
                <option value="ExAC/1.3.0-r0.3/ExAC">ExAC</option>
                <option value="COSMIC/1.1.0-COSMIC71/SomaticMutationsCoding">COSMIC</option>
            </select>
            <button type="submit">Query</button>
            <pre id="form-query-output"></pre>
        </form>

        <script>
            SolveBio.init({
                accessToken: 'ACCESS TOKEN'
            });

            // Query datasets given form input
            $("#form-query").submit(function(event) {
                var query = $("#form-query input[name=query]").val();
                var dataset = $("#form-query select[name=dataset] option:selected").val();
                var output = $("#form-query-output");
                $("#form-query-output").text("");

                SolveBio.Expression('entity_ids("variant", query)', 'string', true)
                    .evaluate({query: query})
                    .catch(function(response) {
                        output.text("Error: " + response.detail);
                    })
                    .then(function(response) {
                        // NOTE: There may be multiple entity IDs returned for a variant.
                        var variant = response.result[0];
                        if (!variant) {
                            output.text("Variant could not be normalized");
                            return;
                        }

                        output.append("Normalized variant IDs: \n");
                        output.append(response.result.join("\n"));
                        output.append("\n\n");

                        SolveBio.Expression('dataset_query(dataset, entities=[["variant", variant]])', 'object', true)
                            .evaluate({variant: variant, dataset: dataset})
                            .catch(function(response) {
                                window.alert("Query error: " + response.detail);
                            })
                            .then(function(response) {
                                var records = response.result;
                                if (records.length > 0) {
                                    records.map(function(r) {
                                        output.append(JSON.stringify(r) + "\n");
                                    });
                                }
                                else {
                                    output.append("No records were found for the variant.");
                                }
                            });
                    });

                event.preventDefault();
            });

        </script>
    </body>
</html>
